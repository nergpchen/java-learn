#### 类的加载原理

类的加载过程分为加载、链接和初始化.

1.加载：

```
把字节码数据读取到虚拟机中，并映射为JVM认可的数据结构，通常是class对象.在这个阶段，用户可以自定义类加载器，实现自己的加载过程.
```

**加载阶段由三个基本动作组成：**

1\) 通过类型的完全限定名，产生一个代表该类型的二进制数据流（根本没有指明从哪里获取、怎样获取，可以说一个非常开放的平台了）

2\) 解析这个二进制数据流为方法区内的运行时数据结构

3\) 创建一个表示该类型的java.lang.Class类的实例，作为方法区这个类的各种数据的访问入口。

**通过类型的完全限定名，产生一个代表该类型的二进制数据流的几种常见形式：**

* 从zip包中读取，成为日后JAR、EAR、WAR格式的基础；

* 从网络中获取，这种场景最典型的应用就是Applet;

* 运行时计算生成，这种场景最常用的就是动态代理技术了；

* 由其他文件生成，比如我们的JSP；

**注意：** 非数组类加载阶段既可以使用系统提供的类加载器来完成，也可以由用户自定义的类加载器去完成。（即重写一个类加载器的loadClass（）方法）

#### 2.链接

第二阶段是链接（Linking），这是核心的步骤，简单说是把原始的类定义信息平滑地转化入 JVM 运行的过程中.  
  链接可以细分为3个步骤:

* 验证:

  **为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全**。

  验证是虚拟机对自身保护的一项重要工作。这个阶段是否严谨，直接决定了java虚拟机是否能承受恶意代码的攻击。

从整体上看，验证阶段大致上会完成4个阶段的校验工作：**文件格式、元数据、字节码、符号引用**。

* 准备

      **准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。**

（备注：这时候进行内存分配的仅包括类变量（被static修饰的变量），而不包括实例变量，实例变量将会在对象实例化时随着对象一起分配在Java堆中）

* 解析

   **解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。**

**那么符号引用与直接引用有什么关联呢？**

#### 3.初始化阶段

```

```

如下图:

![](/assets/classloader.png)

#### 双亲委派模型

简单说就是当类加载器（Class-Loader）试图加载某个类的时候,除非父加载器找不到相应类型,否则把加载类的任务交给当前加载器的父类去执行

#### 类加载器

从Java虚拟机的角度分为两种不同的类加载器：**启动类加载器（Bootstrap ClassLoader）**和**其他类加载器**。其中启动类加载器，使用C++语言实现，是虚拟机自身的一部分；其余的类加载器都由Java语言实现，独立于虚拟机之外，并且全都继承自**java.lang.ClassLoader类**。（这里只限于HotSpot虚拟机）。

从Java开发人员的角度来看，绝大部分Java程序都会使用到以下3种系统提供的类加载器。

**启动类加载器（Bootstrap ClassLoader）：**

这个类加载器负责将存放在\lib目录中的，或者被-Xbootclasspath参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如rt.jar，名字不符合的类库即使放在lib目录中也不会被加载）类库加载到虚拟机内存中。

**扩展类加载器（Extension ClassLoader）：**

这个加载器由sun.misc.Launcher$ExtClassLoader实现，它负责加载\lib\ext目录中的，或者被java.ext.dirs系统变量所指定的路径中的所有类库，开发者可以直接使用扩展类加载器。

**应用程序类加载器（Application ClassLoader）：**

这个类加载器由sun.misc.Launcher$AppClassLoader实现。由于这个类加载器是ClassLoader中的getSystemClassLoader\(\)方法的返回值，所以一般也称它为系统类加载器。它负责加载用户类路径（ClassPath）上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。

我们的应用程序都是由这3种类加载器互相配合进行加载的，如果有必要，还可以加入自己定义的类加载器。

引用:

[https://mp.weixin.qq.com/s?\_\_biz=MzU4NDQ4MzU5OA==&mid=2247483934&idx=1&sn=f247f9bee4e240f5e7fac25659da3bff&chksm=fd98547fcaefdd6996e1a7046e03f29df9308bdf82ceeffd111112766ffd3187892700f64b40&scene=21\#wechat\_redirect](https://mp.weixin.qq.com/s?__biz=MzU4NDQ4MzU5OA==&mid=2247483934&idx=1&sn=f247f9bee4e240f5e7fac25659da3bff&chksm=fd98547fcaefdd6996e1a7046e03f29df9308bdf82ceeffd111112766ffd3187892700f64b40&scene=21#wechat_redirect)

